<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.expenses.ExpenseMapper">

    <!-- =========================================================
         1) 지출 목록 조회 (검색 조건 포함)
       ========================================================= -->
    <select id="selectExpenseList" parameterType="com.health.app.expenses.ExpenseSearchDto"
            resultType="com.health.app.expenses.ExpenseDetailDto">
        SELECT
            e.expense_id        AS expenseId,
            e.branch_id         AS branchId,
            b.branch_name       AS branchName,
            e.expense_at        AS expenseAt,
            e.category_code     AS categoryCode,
            e.amount            AS amount,
            e.description       AS description,
            e.memo              AS memo,
            e.handled_by        AS handledBy,
            h.name              AS handledByName,
            e.settlement_flag   AS settlementFlag,
            e.create_user       AS createUser,
            cu.name             AS createUserName,
            e.create_date       AS createDate,
            e.update_user       AS updateUser,
            uu.name             AS updateUserName,
            e.update_date       AS updateDate
        FROM expenses e
        JOIN branch b ON b.branch_id = e.branch_id
        LEFT JOIN users h ON h.user_id = e.handled_by
        LEFT JOIN users cu ON cu.user_id = e.create_user
        LEFT JOIN users uu ON uu.user_id = e.update_user
        <where>
            AND e.use_yn = 1
            AND b.use_yn = 1

            <if test="branchId != null and branchId != 0">
                AND e.branch_id = #{branchId}
            </if>

            <if test="categoryCode != null and categoryCode != ''">
                AND e.category_code = #{categoryCode}
            </if>

            <if test="settlementFlag != null">
                AND e.settlement_flag = #{settlementFlag}
            </if>

            <if test="startDate != null">
                AND DATE(e.expense_at) &gt;= #{startDate}
            </if>

            <if test="endDate != null">
                AND DATE(e.expense_at) &lt;= #{endDate}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                    e.description LIKE CONCAT('%', #{keyword}, '%')
                    OR e.memo LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
        ORDER BY e.expense_id DESC
        <if test="offset != null and pageSize != null">
            LIMIT #{offset}, #{pageSize}
        </if>
    </select>

    <!-- =========================================================
         2) 지출 목록 총 개수
       ========================================================= -->
    <select id="selectExpenseCount" parameterType="com.health.app.expenses.ExpenseSearchDto"
            resultType="int">
        SELECT COUNT(*)
        FROM expenses e
        JOIN branch b ON b.branch_id = e.branch_id
        <where>
            AND e.use_yn = 1
            AND b.use_yn = 1

            <if test="branchId != null and branchId != 0">
                AND e.branch_id = #{branchId}
            </if>

            <if test="categoryCode != null and categoryCode != ''">
                AND e.category_code = #{categoryCode}
            </if>

            <if test="settlementFlag != null">
                AND e.settlement_flag = #{settlementFlag}
            </if>

            <if test="startDate != null">
                AND DATE(e.expense_at) &gt;= #{startDate}
            </if>

            <if test="endDate != null">
                AND DATE(e.expense_at) &lt;= #{endDate}
            </if>

            <if test="keyword != null and keyword != ''">
                AND (
                    e.description LIKE CONCAT('%', #{keyword}, '%')
                    OR e.memo LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>
        </where>
    </select>

    <!-- =========================================================
         3) 지출 상세 조회
       ========================================================= -->
    <select id="selectExpenseDetail" parameterType="long"
            resultType="com.health.app.expenses.ExpenseDetailDto">
        SELECT
            e.expense_id        AS expenseId,
            e.branch_id         AS branchId,
            b.branch_name       AS branchName,
            e.expense_at        AS expenseAt,
            e.category_code     AS categoryCode,
            e.amount            AS amount,
            e.description       AS description,
            e.memo              AS memo,
            e.handled_by        AS handledBy,
            h.name              AS handledByName,
            e.settlement_flag   AS settlementFlag,
            e.create_user       AS createUser,
            cu.name             AS createUserName,
            e.create_date       AS createDate,
            e.update_user       AS updateUser,
            uu.name             AS updateUserName,
            e.update_date       AS updateDate
        FROM expenses e
        JOIN branch b ON b.branch_id = e.branch_id
        LEFT JOIN users h ON h.user_id = e.handled_by
        LEFT JOIN users cu ON cu.user_id = e.create_user
        LEFT JOIN users uu ON uu.user_id = e.update_user
        WHERE e.expense_id = #{expenseId}
          AND e.use_yn = 1
    </select>

    <!-- =========================================================
         4) 지출 등록
       ========================================================= -->
    <insert id="insertExpense" parameterType="com.health.app.expenses.ExpenseDto"
            useGeneratedKeys="true" keyProperty="expenseId">
        INSERT INTO expenses (
            branch_id,
            expense_at,
            category_code,
            amount,
            description,
            memo,
            handled_by,
            settlement_flag,
            create_user,
            use_yn
        ) VALUES (
            #{branchId},
            #{expenseAt},
            #{categoryCode},
            #{amount},
            #{description},
            #{memo},
            #{handledBy},
            #{settlementFlag},
            #{createUser},
            TRUE
        )
    </insert>

    <!-- =========================================================
         5) 지출 수정
       ========================================================= -->
    <update id="updateExpense" parameterType="com.health.app.expenses.ExpenseDto">
        UPDATE expenses
        SET
            branch_id = #{branchId},
            expense_at = #{expenseAt},
            category_code = #{categoryCode},
            amount = #{amount},
            description = #{description},
            memo = #{memo},
            handled_by = #{handledBy},
            settlement_flag = #{settlementFlag},
            update_user = #{updateUser}
        WHERE expense_id = #{expenseId}
          AND use_yn = 1
    </update>

    <!-- =========================================================
         6) 지출 삭제 (논리 삭제)
       ========================================================= -->
    <update id="deleteExpense">
        UPDATE expenses
        SET
            use_yn = FALSE,
            update_user = #{updateUser}
        WHERE expense_id = #{expenseId}
    </update>

    <!-- =========================================================
         7) 지점 옵션 조회 (드롭다운용)
       ========================================================= -->
    <select id="selectBranchOptions" resultType="com.health.app.inventory.OptionDto">
        SELECT
            branch_id   AS value,
            branch_name AS label
        FROM branch
        WHERE use_yn = 1
        ORDER BY branch_name
    </select>

</mapper>
