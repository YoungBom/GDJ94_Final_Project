<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.security.mapper.AuthUserMapper">

    <select id="findByLoginId" resultType="com.health.app.security.dto.AuthUserDto">
        SELECT
            user_id           AS userId,
            login_id          AS loginId,
            password          AS password,
            name              AS name,
            role_code         AS roleCode,
            status_code       AS statusCode,
            lock_status_code  AS lockStatusCode,
            fail_count        AS failCount,
            lock_until        AS lockUntil,
            use_yn            AS useYn,
            branch_id         AS branchId
        FROM users
        WHERE login_id = #{loginId}
    </select>

    <update id="increaseFailCount">
        UPDATE users
        SET fail_count = COALESCE(fail_count, 0) + 1
        WHERE user_id = #{userId}
    </update>

    <update id="lockUser">
        UPDATE users
        SET lock_status_code = 'AL002',
            lock_until = #{lockUntil}
        WHERE user_id = #{userId}
    </update>

    <update id="resetFailCount">
        UPDATE users
        SET fail_count = 0,
            lock_status_code = 'AL001',
            lock_until = NULL
        WHERE user_id = #{userId}
    </update>

    <insert id="insertLoginHistory" parameterType="com.health.app.security.dto.LoginHistoryDto">
        INSERT INTO login_history
        (user_id, login_id_input, success_yn, fail_reason)
        VALUES
        (#{userId}, #{loginIdInput}, #{successYn}, #{failReason})
    </insert>

</mapper>
