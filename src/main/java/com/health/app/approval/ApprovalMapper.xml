<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.approval.ApprovalMapper">
 <select id="selectMyInbox" resultType="com.health.app.approval.ApprovalInboxRowDTO">
    SELECT
        d.doc_id             AS docId,
        v.doc_ver_id         AS docVerId,
        d.doc_no             AS docNo,
        d.type_code          AS typeCode,
        d.form_code          AS formCode,
        d.status_code        AS docStatusCode,
        v.ver_status_code    AS verStatusCode,
        d.drafter_user_id    AS drafterId,
        d.drafter_branch_id  AS branchId,
        l.seq                AS mySeq,
        l.status_code        AS myLineStatusCode,
        v.create_date        AS submittedAt,
        d.update_date        AS updateDate
    FROM approval_lines l
    JOIN approval_document_versions v ON v.doc_ver_id = l.doc_ver_id
    JOIN approval_documents d ON d.doc_id = v.doc_id
    WHERE l.use_yn = 1
      AND v.use_yn = 1
      AND d.use_yn = 1
      AND l.user_id = #{approverId}
      AND l.status_code = 'ALS002'
      AND d.status_code = 'AS002'
    ORDER BY v.create_date DESC, d.doc_id DESC
  </select>

    <!-- 1) documents -->
    <insert id="insertDocument"
            parameterType="com.health.app.approval.ApprovalDraftDTO"
            useGeneratedKeys="true"
            keyProperty="docId">
        INSERT INTO approval_documents
        (
            doc_no,
            type_code,
            form_code,
            status_code,
            drafter_user_id,
            drafter_branch_id,
            current_doc_ver_id,
            create_user,
            create_date,
            update_user,
            update_date,
            use_yn
        )
        VALUES
        (
            #{docNo},
            #{typeCode},
            #{formCode},
            #{statusCode},
            #{drafterId},
            #{branchId},
            NULL,
            #{createUser},
            NOW(),
            #{updateUser},
            NOW(),
            1
        )
    </insert>

    <!-- 2) versions -->
    <insert id="insertDocumentVersion"
            parameterType="com.health.app.approval.ApprovalDraftDTO"
            useGeneratedKeys="true"
            keyProperty="docVerId">
        INSERT INTO approval_document_versions
        (
            doc_id,
            version_no,
            ver_status_code,
            title,
            body,
            create_user,
            create_date,
            use_yn
        )
        VALUES
        (
            #{docId},
            #{versionNo},
            #{verStatusCode},
            #{title},
            #{body},
            #{createUser},
            NOW(),
            TRUE
        )
    </insert>

    <insert id="insertDocumentExt"
            parameterType="com.health.app.approval.ApprovalDraftDTO">
        INSERT INTO approval_document_ext
        (
            doc_ver_id,
            ext_dt1, ext_dt2, ext_dt3, ext_dt4,
            ext_no1, ext_no2, ext_no3, ext_no4,
            ext_txt1, ext_txt2, ext_txt3, ext_txt4, ext_txt5, ext_txt6,
            ext_code1, ext_code2, ext_code3, ext_code4,
            create_user,
            create_date,
            use_yn
        )
        VALUES
        (
            #{docVerId},
            #{extDt1}, #{extDt2}, #{extDt3}, #{extDt4},
            #{extNo1}, #{extNo2}, #{extNo3}, #{extNo4},
            #{extTxt1}, #{extTxt2}, #{extTxt3}, #{extTxt4}, #{extTxt5}, #{extTxt6},
            #{extCode1}, #{extCode2}, #{extCode3}, #{extCode4},
            #{createUser},
            NOW(),
            TRUE
        )
    </insert>

    <update id="updateCurrentVersion"
            parameterType="com.health.app.approval.ApprovalDraftDTO">
        UPDATE approval_documents
        SET
            current_doc_ver_id = #{docVerId},
            update_user = #{updateUser},
            update_date = NOW()
        WHERE doc_id = #{docId}
    </update>

    <select id="selectBranchIdByUserId" resultType="long">
        SELECT branch_id
        FROM users
        WHERE user_id = #{userId}
    </select>

    <delete id="deleteLinesByDocVerId">
        DELETE FROM approval_lines
        WHERE doc_ver_id = #{docVerId}
    </delete>

    <insert id="insertLine" parameterType="com.health.app.approval.ApprovalLineDTO">
	  INSERT INTO approval_lines (
	      doc_ver_id, seq, line_role_code, user_id,
	      status_code, acted_at, comment, signature_file_id,
	      create_user, create_date, update_user, update_date, use_yn
	  ) VALUES (
	      #{docVerId}, #{seq}, #{lineRoleCode}, #{approverId},
	      #{lineStatusCode}, #{actedAt}, #{comment}, #{signatureFileId},
	      #{createUser}, NOW(), #{updateUser}, NOW(), 1
	  )
	</insert>


    <select id="selectLinesByDocVerId"
        parameterType="long"
        resultType="com.health.app.approval.ApprovalLineDTO">
	  SELECT
	      l.line_id        AS lineId,
	      l.doc_ver_id     AS docVerId,
	      l.seq            AS seq,
	      l.line_role_code AS lineRoleCode,
	      l.user_id        AS approverId,
	      u.name           AS approverName,
	      l.status_code    AS lineStatusCode,
	      l.acted_at       AS actedAt,
	      l.comment        AS comment,
	      l.signature_file_id AS signatureFileId,
	      l.create_user    AS createUser,
	      l.create_date    AS createDate,
	      l.update_user    AS updateUser,
	      l.update_date    AS updateDate,
	      l.use_yn         AS useYn
	  FROM approval_lines l
	  JOIN users u ON u.user_id = l.user_id
	  WHERE l.doc_ver_id = #{docVerId}
	    AND l.use_yn = 1
	  ORDER BY l.seq
	</select>
	
	<select id="selectHeadOfficeApprovers" resultType="map">
	  SELECT
	      u.user_id         AS userId
	    , u.name            AS name
	    , u.department_code AS deptCode
	    , u.role_code       AS roleCode
	  FROM users u
	  WHERE u.branch_id IS NULL
	    AND u.use_yn = 1
	  ORDER BY u.department_code, u.name
	</select>
	
	<select id="selectBranchApprovers" resultType="map">
	  SELECT
	      u.user_id   AS userId
	    , u.name      AS name
	    , u.branch_id AS branchId
	    , u.role_code AS roleCode
	  FROM users u
	  WHERE u.branch_id IS NOT NULL
	    AND u.use_yn = 1
	  ORDER BY u.branch_id, u.name
	</select>
	
	<select id="selectBranches" resultType="map">
	  SELECT
	      b.branch_id   AS branchId
	    , b.branch_name AS branchName
	  FROM branch b
	  ORDER BY b.branch_id
	</select>
	
	<select id="selectDrafterIdByDocVerId" resultType="long">
	  SELECT d.drafter_user_id
	  FROM approval_documents d
	  JOIN approval_document_versions v ON v.doc_id = d.doc_id
	  WHERE v.doc_ver_id = #{docVerId}
	  LIMIT 1
	</select>
	
	<select id="countLinesByDocVerId" resultType="int">
	  SELECT COUNT(*)
	  FROM approval_lines
	  WHERE doc_ver_id = #{docVerId}
	    AND use_yn = 1
	</select>
	
	<select id="selectDocStatusByDocVerId" resultType="string">
	  SELECT d.status_code
	  FROM approval_documents d
	  JOIN approval_document_versions v ON v.doc_id = d.doc_id
	  WHERE v.doc_ver_id = #{docVerId}
	  LIMIT 1
	</select>
	
	<update id="updateDocumentStatusByDocVerId">
	  UPDATE approval_documents d
	  JOIN approval_document_versions v ON v.doc_id = d.doc_id
	  SET d.status_code = #{statusCode},
	      d.update_user = #{updateUser},
	      d.update_date = NOW()
	  WHERE v.doc_ver_id = #{docVerId}
	</update>
	
	<update id="updateVersionStatusByDocVerId">
	  UPDATE approval_document_versions
	  SET ver_status_code = #{verStatusCode}
	  WHERE doc_ver_id = #{docVerId}
	</update>
	
	<update id="updateAllLinesStatusByDocVerId">
	  UPDATE approval_lines
	  SET status_code = #{lineStatusCode},
	      acted_at = NULL,
	      comment = NULL,
	      signature_file_id = NULL,
	      update_user = #{updateUser},
	      update_date = NOW()
	  WHERE doc_ver_id = #{docVerId}
	    AND use_yn = 1
	</update>
	
	<update id="updateFirstLineToPending">
	  UPDATE approval_lines
	  SET status_code = #{lineStatusCode},
	      update_user = #{updateUser},
	      update_date = NOW()
	  WHERE doc_ver_id = #{docVerId}
	    AND use_yn = 1
	    AND seq = (
	      SELECT t.min_seq
	      FROM (
	        SELECT MIN(seq) AS min_seq
	        FROM approval_lines
	        WHERE doc_ver_id = #{docVerId}
	          AND use_yn = 1
	      ) t
	    )
	</update>
	
	<select id="selectProductsByBranch"
        parameterType="long"
        resultType="com.health.app.approval.BranchProductStockDTO">
    	SELECT
	        p.product_id   AS productId,
	        p.product_name AS productName,
	        i.quantity     AS stockQty
	    FROM inventory i
	    JOIN product p ON p.product_id = i.product_id
	    WHERE i.use_yn = 1
	      AND p.use_yn = 1
	      AND i.branch_id = #{branchId}
	    ORDER BY p.product_name ASC
	</select>
		
</mapper>
