<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.inventory.InventoryMapper">

    <!-- =========================================================
         1) 재고 목록 조회 (리스트)
         - 기준수량(thresholdValue), 부족여부(lowStock) 계산
       ========================================================= -->
    <select id="selectInventoryList"
            parameterType="map"
            resultType="com.health.app.inventory.InventoryViewDto">

        SELECT
        i.inventory_id      AS inventoryId,
        i.branch_id         AS branchId,
        b.branch_name       AS branchName,
        i.product_id        AS productId,
        p.product_name      AS productName,
        i.quantity          AS quantity,

        CASE
        WHEN i.low_stock_threshold IS NULL OR i.low_stock_threshold = 0
        THEN p.reorder_point
        ELSE i.low_stock_threshold
        END AS thresholdValue,

        CASE
        WHEN i.quantity &lt;=
        CASE
        WHEN i.low_stock_threshold IS NULL OR i.low_stock_threshold = 0
        THEN p.reorder_point
        ELSE i.low_stock_threshold
        END
        THEN 1
        ELSE 0
        END AS lowStock

        FROM inventory i
        JOIN branch  b ON b.branch_id  = i.branch_id
        JOIN product p ON p.product_id = i.product_id

        <where>
            AND i.use_yn = 1
            AND b.use_yn = 1
            AND p.use_yn = 1

            <if test="branchId != null and branchId != 0">
                AND i.branch_id = #{branchId}
            </if>

            <if test="keyword != null and keyword != ''">
                AND p.product_name LIKE CONCAT('%', #{keyword}, '%')
            </if>

            <if test="onlyLowStock != null and onlyLowStock == true">
                AND i.quantity &lt;=
                CASE
                WHEN i.low_stock_threshold IS NULL OR i.low_stock_threshold = 0
                THEN p.reorder_point
                ELSE i.low_stock_threshold
                END
            </if>
        </where>

        ORDER BY lowStock DESC, i.quantity ASC, p.product_name ASC
    </select>


    <!-- =========================================================
         2) 지점 옵션
       ========================================================= -->
		<select id="selectBranchOptions"
		        resultType="com.health.app.inventory.OptionDto">
		
		    SELECT
		    branch_id   AS id,
		    branch_name AS name
		    FROM branch
		    WHERE use_yn = 1
		    ORDER BY
		        CASE
		            WHEN branch_name = '본사' THEN 0
		            WHEN branch_name LIKE '서울%' THEN 1
		            WHEN branch_name LIKE '경기%' THEN 2
		            WHEN branch_name LIKE '인천%' THEN 3
		            WHEN branch_name LIKE '부산%' THEN 4
		            WHEN branch_name LIKE '제주%' THEN 5
		            ELSE 99
		        END,
		        branch_name ASC
		</select>



    <!-- =========================================================
         3) 상품 옵션 (선택)
       ========================================================= -->
    <select id="selectProductOptions"
            parameterType="map"
            resultType="com.health.app.inventory.OptionDto">

        SELECT
        p.product_id   AS id,
        p.product_name AS name
        FROM product p
        WHERE p.use_yn = 1

        <if test="branchId != null and branchId != 0">
            AND EXISTS (
            SELECT 1
            FROM inventory i
            WHERE i.product_id = p.product_id
            AND i.branch_id  = #{branchId}
            AND i.use_yn     = 1
            )
        </if>

        ORDER BY p.product_name ASC
    </select>


    <!-- =========================================================
         4) 재고 상세 조회 (정석: 상세 DTO)
         - raw + 계산 값 제공
       ========================================================= -->
    <select id="selectInventoryDetail"
            parameterType="map"
            resultType="com.health.app.inventory.InventoryDetailDto">

        SELECT
        i.branch_id           AS branchId,
        b.branch_name         AS branchName,
        i.product_id          AS productId,
        p.product_name        AS productName,

        i.quantity            AS quantity,

        i.low_stock_threshold AS lowStockThreshold,
        p.reorder_point       AS reorderPoint,

        CASE
        WHEN i.low_stock_threshold IS NULL OR i.low_stock_threshold = 0
        THEN p.reorder_point
        ELSE i.low_stock_threshold
        END AS standardQuantity,

        CASE
        WHEN i.quantity &lt;=
        CASE
        WHEN i.low_stock_threshold IS NULL OR i.low_stock_threshold = 0
        THEN p.reorder_point
        ELSE i.low_stock_threshold
        END
        THEN 1
        ELSE 0
        END AS lowStock

        FROM inventory i
        JOIN branch  b ON b.branch_id  = i.branch_id
        JOIN product p ON p.product_id = i.product_id

        WHERE i.use_yn = 1
        AND b.use_yn = 1
        AND p.use_yn = 1
        AND i.branch_id  = #{branchId}
        AND i.product_id = #{productId}
    </select>


    <!-- =========================================================
         5) 재고 이력 조회
       ========================================================= -->
    <select id="selectInventoryHistory"
            parameterType="map"
            resultType="com.health.app.inventory.InventoryHistoryViewDto">

        SELECT
        h.inventory_history_id AS inventoryHistoryId,

        h.branch_id            AS branchId,
        b.branch_name          AS branchName,
        h.product_id           AS productId,
        p.product_name         AS productName,

        h.move_type_code       AS moveTypeCode,
        h.quantity             AS quantity,
        h.reason               AS reason,
        h.ref_type             AS refType,
        h.ref_id               AS refId,

        h.create_user          AS createUser,
        h.create_date          AS createDate,
        h.update_user          AS updateUser,
        h.update_date          AS updateDate

        FROM inventory_history h
        JOIN branch  b ON b.branch_id  = h.branch_id
        JOIN product p ON p.product_id = h.product_id

        <where>
            AND h.use_yn = 1
            AND b.use_yn = 1
            AND p.use_yn = 1

            <if test="branchId != null and branchId != 0">
                AND h.branch_id = #{branchId}
            </if>

            <if test="productId != null and productId != 0">
                AND h.product_id = #{productId}
            </if>
        </where>

        ORDER BY h.create_date DESC, h.inventory_history_id DESC
    </select>


    <!-- =========================================================
         6) 재고 수량 업데이트
       ========================================================= -->
    <update id="updateInventoryQuantity" parameterType="map">
        UPDATE inventory
        SET
        quantity = #{quantity}
        <if test="lowStockThreshold != null">
            , low_stock_threshold = #{lowStockThreshold}
        </if>
        <if test="updateUser != null">
            , update_user = #{updateUser}
        </if>
        , update_date = NOW()
        WHERE use_yn = 1
        AND branch_id  = #{branchId}
        AND product_id = #{productId}
    </update>


    <!-- =========================================================
         7) 재고 이력 INSERT
       ========================================================= -->
    <insert id="insertInventoryHistory" parameterType="map">
        INSERT INTO inventory_history
        (
        branch_id,
        product_id,
        move_type_code,
        quantity,
        reason,
        ref_type,
        ref_id,
        create_user,
        create_date,
        update_user,
        update_date,
        use_yn
        )
        VALUES
        (
        #{branchId},
        #{productId},
        #{moveTypeCode},
        #{quantity},
        #{reason},
        #{refType},
        #{refId},
        #{createUser},
        NOW(),
        #{createUser},
        NOW(),
        1
        )
    </insert>

    <!-- =========================================================
     8) 기준수량(지점별 low_stock_threshold) 업데이트
     - null/0이면 상품 기본(reorder_point)로 fallback 되도록 설계돼 있음
   ========================================================= -->
    <update id="updateLowStockThreshold" parameterType="map">
        UPDATE inventory
        SET
        low_stock_threshold = #{lowStockThreshold}
        <if test="updateUser != null">
            , update_user = #{updateUser}
        </if>
        , update_date = NOW()
        WHERE use_yn = 1
        AND branch_id  = #{branchId}
        AND product_id = #{productId}
    </update>

    <!-- =========================================================
     9) inventory_id 조회 (audit_log.target_id에 넣기 위함)
   ========================================================= -->
    <select id="selectInventoryId" parameterType="map" resultType="long">
        SELECT inventory_id
        FROM inventory
        WHERE use_yn = 1
        AND branch_id = #{branchId}
        AND product_id = #{productId}
    </select>

    <!-- =========================================================
         10) 감사로그 INSERT (DB 컬럼명: action_type/target_type/target_id)
       ========================================================= -->
    <insert id="insertAuditLog" parameterType="map">
        INSERT INTO audit_log
        (
        actor_user_id,
        action_type,
        target_type,
        target_id,
        before_value,
        after_value,
        reason,
        create_user,
        create_date,
        update_user,
        update_date,
        use_yn
        )
        VALUES
        (
        #{actorUserId},
        #{actionType},
        #{targetType},
        #{targetId},
        #{beforeValue},
        #{afterValue},
        #{reason},
        #{createUser},
        NOW(),
        #{createUser},
        NOW(),
        1
        )
    </insert>

    <!-- =========================================================
         11) 감사로그 조회 (target_id = inventory.inventory_id JOIN)
       ========================================================= -->
    <select id="selectAuditLogs" parameterType="map" resultType="com.health.app.inventory.AuditLogDto">
        SELECT
        al.audit_id       AS auditId,
        al.actor_user_id  AS actorUserId,
        al.action_type    AS actionType,
        al.target_type    AS targetType,
        al.target_id      AS targetId,
        al.before_value   AS beforeValue,
        al.after_value    AS afterValue,
        al.reason         AS reason,
        DATE_FORMAT(al.create_date, '%Y-%m-%d %H:%i:%s') AS createdAt,

        i.branch_id       AS branchId,
        b.branch_name     AS branchName,
        i.product_id      AS productId,
        p.product_name    AS productName

        FROM audit_log al
        LEFT JOIN inventory i ON i.inventory_id = al.target_id
        LEFT JOIN branch b ON b.branch_id = i.branch_id
        LEFT JOIN product p ON p.product_id = i.product_id

        WHERE al.use_yn = 1

        <if test="from != null and from != ''">
            AND al.create_date &gt;= CONCAT(#{from}, ' 00:00:00')
        </if>
        <if test="to != null and to != ''">
            AND al.create_date &lt;= CONCAT(#{to}, ' 23:59:59')
        </if>

        <if test="actionType != null and actionType != ''">
            AND al.action_type = #{actionType}
        </if>

        <if test="branchId != null and branchId != 0">
            AND i.branch_id = #{branchId}
        </if>

        <if test="productId != null and productId != 0">
            AND i.product_id = #{productId}
        </if>

        <if test="keyword != null and keyword != ''">
            AND (
            al.reason LIKE CONCAT('%', #{keyword}, '%')
            OR al.before_value LIKE CONCAT('%', #{keyword}, '%')
            OR al.after_value LIKE CONCAT('%', #{keyword}, '%')
            OR b.branch_name LIKE CONCAT('%', #{keyword}, '%')
            OR p.product_name LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        ORDER BY al.audit_id DESC
        LIMIT 300
    </select>



</mapper>
