<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.user.UserAdminMapper">

    <select id="selectUserAdminList"
            resultType="com.health.app.user.UserAdminDTO">
        <![CDATA[
        SELECT
            u.user_id            AS userId,
            u.login_id           AS loginId,
            u.name               AS name,
            u.email              AS email,
            u.phone              AS phone,

            u.role_code          AS roleCode,
            cr.code_desc         AS roleName,

            u.department_code    AS departmentCode,
            cd.code_desc         AS departmentName,

            b.branch_name        AS branchName,

            u.status_code   AS userStatusCode,
            cs.code_desc         AS userStatusName,

            u.fail_count         AS failCount,
            u.lock_status_code   AS lockStatusCode,

            u.create_date        AS createDate
        FROM users u
        LEFT JOIN branch b
               ON b.branch_id = u.branch_id

        LEFT JOIN common_code cr
               ON cr.code_group = 'ROLE'
              AND cr.code = u.role_code

        LEFT JOIN common_code cd
               ON cd.code_group = 'DEPARTMENT_CODE'
              AND cd.code = u.department_code

        LEFT JOIN common_code cs
               ON cs.code_group = 'USER_STATUS'
              AND cs.code = u.status_code

        WHERE u.use_yn = TRUE
        ORDER BY u.user_id DESC
        ]]>
    </select>
    
    <select id="selectUserAdminDetail"
	        parameterType="long"
	        resultType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	SELECT
	    u.user_id          AS userId,
	    u.login_id         AS loginId,
	    u.name             AS name,
	    u.email            AS email,
	    u.phone            AS phone,
	    
        u.branch_id        AS branchId,
	    u.post_no          AS postNo,
	    u.base_address     AS baseAddress,
	    u.detail_address   AS detailAddress,
	
	    u.role_code        AS roleCode,
	    cr.code_desc       AS roleName,
	
	    u.department_code  AS departmentCode,
	    cd.code_desc       AS departmentName,
	
	    b.branch_name      AS branchName,
	
	    u.status_code      AS userStatusCode,
	    cs.code_desc       AS userStatusName,
	
	    u.fail_count       AS failCount,
	    u.lock_status_code AS lockStatusCode,
	
	    u.use_yn           AS useYn,
	    
	    u.create_date      AS createDate
	FROM users u
	LEFT JOIN branch b
	       ON b.branch_id = u.branch_id
	LEFT JOIN common_code cr
	       ON cr.code_group = 'ROLE'
	      AND cr.code = u.role_code
	LEFT JOIN common_code cd
	       ON cd.code_group = 'DEPARTMENT_CODE'
	      AND cd.code = u.department_code
	LEFT JOIN common_code cs
	       ON cs.code_group = 'USER_STATUS'
	      AND cs.code = u.status_code
	WHERE u.user_id = #{userId}
	]]>
	</select>
    
<insert id="insertUser"
	        parameterType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	INSERT INTO users (
	    login_id,
	    password,
	    name,
	    post_no,
	    base_address,
	    detail_address,
	    email,
	    phone,
	    branch_id,
	    department_code,
	    role_code,
	    status_code,
	    fail_count,
	    create_user,
	    use_yn,
	    create_date
	) VALUES (
	    #{loginId},
	    #{password},
	    #{name},
	    #{postNo},
	    #{baseAddress},
	    #{detailAddress},
	    #{email},
	    #{phone},
	    #{branchId},
	    #{departmentCode},
	    #{roleCode},
	    'US001',
	    0,
	    #{createUser},
	    TRUE,
	    NOW()
	)
	]]>
	</insert>
	
	<update id="updateUser"
	        parameterType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	UPDATE users
	SET
	    name = #{name},
	    email = #{email},
	    phone = #{phone},
	    post_no = #{postNo},
	    base_address = #{baseAddress},
	    detail_address = #{detailAddress},
	    department_code = #{departmentCode},
	    role_code = #{roleCode},
	    branch_id = #{branchId},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	]]>
	</update>

	<insert id="insertUserBranchLog">
	INSERT INTO user_branch_log (
	    user_id, before_branch_id, after_branch_id,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{beforeBranchId}, #{afterBranchId},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<insert id="insertRoleChangeLog">
	INSERT INTO role_change_log (
	    user_id, before_role_code, after_role_code,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{beforeRoleCode}, #{afterRoleCode},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<insert id="insertUserHistory">
	INSERT INTO user_history (
	    user_id, change_type,
	    before_value, after_value,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{changeType},
	    #{beforeValue}, #{afterValue},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<!-- 사용자 상태 변경 -->
	<update id="updateUserStatus">
	UPDATE users
	SET
	    status_code = #{statusCode},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	</update>

	<update id="updatePassword">
	UPDATE users
	SET
	    password = #{password},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	</update>

	<!-- 사용자의 모든 이력 -->
	<select id="selectUserAllHistory"
	        parameterType="long"
	        resultType="com.health.app.user.UserBranchLogDTO">
	
	<![CDATA[
	SELECT *
	FROM (
	
	    -- ① 기본정보 변경
	    SELECT
	        uh.create_date AS createDate,
	        'UPDATE' AS historyType,
	
	        CASE
	            WHEN uh.change_type = 'department_code' THEN '부서'
	            WHEN uh.change_type = 'status_code'     THEN '사용자 상태'
	            ELSE uh.change_type
	        END AS changeField,
	
	        -- 변경 전
	        CASE
	            WHEN uh.change_type = 'department_code'
	                THEN cd1.code_desc
	            WHEN uh.change_type = 'status_code'
	                THEN sc1.code_desc
	            ELSE uh.before_value
	        END AS beforeValue,
	
	        -- 변경 후
	        CASE
	            WHEN uh.change_type = 'department_code'
	                THEN cd2.code_desc
	            WHEN uh.change_type = 'status_code'
	                THEN sc2.code_desc
	            ELSE uh.after_value
	        END AS afterValue,
	
	        uh.reason,
	        u.name AS createUserName
	
	    FROM user_history uh
	    JOIN users u ON u.user_id = uh.create_user
	
	    -- 부서 코드
	    LEFT JOIN common_code cd1
	      ON cd1.code_group = 'DEPARTMENT_CODE'
	     AND cd1.code = uh.before_value
	
	    LEFT JOIN common_code cd2
	      ON cd2.code_group = 'DEPARTMENT_CODE'
	     AND cd2.code = uh.after_value
	
	    -- 상태 코드
	    LEFT JOIN common_code sc1
	      ON sc1.code_group = 'USER_STATUS'
	     AND sc1.code = uh.before_value
	
	    LEFT JOIN common_code sc2
	      ON sc2.code_group = 'USER_STATUS'
	     AND sc2.code = uh.after_value
	
	    WHERE uh.user_id = #{userId}
	
	    UNION ALL
	
	    -- ② 지점 변경
	    SELECT
	        bl.create_date,
	        'BRANCH',
	        '소속 지점',
	        b1.branch_name,
	        b2.branch_name,
	        bl.reason,
	        u.name
	
	    FROM user_branch_log bl
	    LEFT JOIN branch b1 ON b1.branch_id = bl.before_branch_id
	    LEFT JOIN branch b2 ON b2.branch_id = bl.after_branch_id
	    JOIN users u ON u.user_id = bl.create_user
	    WHERE bl.user_id = #{userId}
	
	    UNION ALL
	
	    -- ③ 권한 변경
	    SELECT
	        rl.create_date,
	        'ROLE',
	        '권한',
	        c1.code_desc,
	        c2.code_desc,
	        rl.reason,
	        u.name
	
	    FROM role_change_log rl
	    LEFT JOIN common_code c1
	      ON c1.code_group = 'ROLE'
	     AND c1.code = rl.before_role_code
	    LEFT JOIN common_code c2
	      ON c2.code_group = 'ROLE'
	     AND c2.code = rl.after_role_code
	    JOIN users u ON u.user_id = rl.create_user
	    WHERE rl.user_id = #{userId}
	
	) h
	ORDER BY createDate DESC
	]]>
	</select>
	
	
	<!-- 회원탈퇴 ( use_yn = 0 ) -->
	<update id="updateUseYn">
	UPDATE users
	SET
	    use_yn = 0,
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	</update>
	



</mapper>
