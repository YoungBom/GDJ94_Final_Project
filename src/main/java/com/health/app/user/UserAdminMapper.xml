<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.user.UserAdminMapper">

    <select id="selectUserAdminList"
            resultType="com.health.app.user.UserAdminDTO">
        <![CDATA[
        SELECT
            u.user_id            AS userId,
            u.login_id           AS loginId,
            u.name               AS name,
            u.email              AS email,
            u.phone              AS phone,

            u.role_code          AS roleCode,
            cr.code_desc         AS roleName,

            u.department_code    AS departmentCode,
            cd.code_desc         AS departmentName,

            b.branch_name        AS branchName,

            u.status_code   AS userStatusCode,
            cs.code_desc         AS userStatusName,

            u.fail_count         AS failCount,
            u.lock_status_code   AS lockStatusCode,

            u.create_date        AS createDate
        FROM users u
        LEFT JOIN branch b
               ON b.branch_id = u.branch_id

        LEFT JOIN common_code cr
               ON cr.code_group = 'ROLE'
              AND cr.code = u.role_code

        LEFT JOIN common_code cd
               ON cd.code_group = 'DEPARTMENT_CODE'
              AND cd.code = u.department_code

        LEFT JOIN common_code cs
               ON cs.code_group = 'USER_STATUS'
              AND cs.code = u.status_code

        WHERE u.use_yn = TRUE
        ORDER BY u.user_id DESC
        ]]>
    </select>
    
    <select id="selectUserAdminDetail"
	        parameterType="long"
	        resultType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	SELECT
	    u.user_id          AS userId,
	    u.login_id         AS loginId,
	    u.name             AS name,
	    u.email            AS email,
	    u.phone            AS phone,
	    
        u.branch_id        AS branchId,
	    u.post_no          AS postNo,
	    u.base_address     AS baseAddress,
	    u.detail_address   AS detailAddress,
	
	    u.role_code        AS roleCode,
	    cr.code_desc       AS roleName,
	
	    u.department_code  AS departmentCode,
	    cd.code_desc       AS departmentName,
	
	    b.branch_name      AS branchName,
	
	    u.status_code      AS userStatusCode,
	    cs.code_desc       AS userStatusName,
	
	    u.fail_count       AS failCount,
	    u.lock_status_code AS lockStatusCode,
	
	    u.create_date      AS createDate
	FROM users u
	LEFT JOIN branch b
	       ON b.branch_id = u.branch_id
	LEFT JOIN common_code cr
	       ON cr.code_group = 'ROLE'
	      AND cr.code = u.role_code
	LEFT JOIN common_code cd
	       ON cd.code_group = 'DEPARTMENT_CODE'
	      AND cd.code = u.department_code
	LEFT JOIN common_code cs
	       ON cs.code_group = 'USER_STATUS'
	      AND cs.code = u.status_code
	WHERE u.user_id = #{userId}
	]]>
	</select>
    
<insert id="insertUser"
	        parameterType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	INSERT INTO users (
	    login_id,
	    password,
	    name,
	    post_no,
	    base_address,
	    detail_address,
	    email,
	    phone,
	    branch_id,
	    department_code,
	    role_code,
	    status_code,
	    fail_count,
	    create_user,
	    use_yn,
	    create_date
	) VALUES (
	    #{loginId},
	    #{password},
	    #{name},
	    #{postNo},
	    #{baseAddress},
	    #{detailAddress},
	    #{email},
	    #{phone},
	    #{branchId},
	    #{departmentCode},
	    #{roleCode},
	    'US001',
	    0,
	    #{createUser},
	    TRUE,
	    NOW()
	)
	]]>
	</insert>
	
	<update id="updateUser"
	        parameterType="com.health.app.user.UserAdminDTO">
	<![CDATA[
	UPDATE users
	SET
	    name = #{name},
	    email = #{email},
	    phone = #{phone},
	    post_no = #{postNo},
	    base_address = #{baseAddress},
	    detail_address = #{detailAddress},
	    department_code = #{departmentCode},
	    role_code = #{roleCode},
	    branch_id = #{branchId},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	]]>
	</update>

	<insert id="insertUserBranchLog">
	INSERT INTO user_branch_log (
	    user_id, before_branch_id, after_branch_id,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{beforeBranchId}, #{afterBranchId},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<insert id="insertRoleChangeLog">
	INSERT INTO role_change_log (
	    user_id, before_role_code, after_role_code,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{beforeRoleCode}, #{afterRoleCode},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<insert id="insertUserHistory">
	INSERT INTO user_history (
	    user_id, change_type,
	    before_value, after_value,
	    reason, create_user, create_date
	) VALUES (
	    #{userId}, #{changeType},
	    #{beforeValue}, #{afterValue},
	    #{reason}, #{createUser}, NOW()
	)
	</insert>

	<update id="updateUserStatus">
	UPDATE users
	SET
	    status_code = #{statusCode},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	</update>

	<update id="updatePassword">
	UPDATE users
	SET
	    password = #{password},
	    update_user = #{updateUser},
	    update_date = NOW()
	WHERE user_id = #{userId}
	</update>

<!-- 사용자관리에서 기본정보 / 상태 변경 이력조회 -->
<select id="selectUserHistory"
        parameterType="long"
        resultType="com.health.app.user.UserHistoryDTO">
SELECT
    change_type    AS changeType,
    before_value   AS beforeValue,
    after_value    AS afterValue,
    reason,
    create_date    AS createDate
FROM user_history
WHERE user_id = #{userId}
ORDER BY create_date DESC
</select>

<!-- 사용자관리에서 지점 변경 이력조회 -->
<select id="selectUserBranchLogs"
        parameterType="long"
        resultType="com.health.app.user.UserBranchLogDTO">
SELECT
    before_branch_id AS beforeBranchId,
    after_branch_id  AS afterBranchId,
    reason,
    create_date      AS createDate
FROM user_branch_log
WHERE user_id = #{userId}
ORDER BY create_date DESC
</select>

<!-- 사용자관리에서 권한 변경 이력조회 -->
<select id="selectRoleChangeLogs"
        parameterType="long"
        resultType="com.health.app.user.RoleChangeLogDTO">
SELECT
    before_role_code AS beforeRoleCode,
    after_role_code  AS afterRoleCode,
    reason,
    create_date      AS createDate
FROM role_change_log
WHERE user_id = #{userId}
ORDER BY create_date DESC
</select>

</mapper>
