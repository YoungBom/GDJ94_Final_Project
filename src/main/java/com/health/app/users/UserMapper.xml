<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.health.app.users.UserMapper">

    <select id="countByLoginId" resultType="int">
        SELECT COUNT(*)
        FROM users
        WHERE login_id = #{loginId}
    </select>

    <insert id="insertUser" parameterType="com.health.app.users.UserDTO">
        INSERT INTO users (
            login_id,
            password,
            name,
            post_no,
            base_address,
    		detail_address,
            department_code,
            email,
            phone,
            branch_id,
            status_code,
            role_code,
            lock_status_code,
            fail_count,
            use_yn,
            create_user,
            create_date
        ) VALUES (
            #{loginId},
            #{password},
            #{name},
            #{postNo},
		    #{baseAddress},
		    #{detailAddress},
            #{departmentCode},
            #{email},
            #{phone},
            #{branchId},
            #{statusCode},
            #{roleCode},
            #{lockStatusCode},
            #{failCount},
            #{useYn},
            #{createUser},
            NOW()
        )
    </insert>
    
	<select id="selectByLoginId"
	    parameterType="java.lang.String"
	    resultType="com.health.app.users.UserDTO">
	SELECT
	    u.user_id,
	    u.login_id,
	    u.name,
	    u.email,
	    u.phone,
	    u.department_code,
	    cd.code_desc AS department_name,
	    u.branch_id,
	    u.post_no,
	    u.base_address,
	    u.detail_address,
	    u.role_code,
	    cr.code_desc AS role_name,
	    u.status_code,
	    u.lock_status_code
	FROM users u
	LEFT JOIN common_code cr
	    ON cr.code_group = 'ROLE'
	   AND cr.code = u.role_code
	LEFT JOIN common_code cd
	    ON cd.code_group = 'DEPARTMENT_CODE'
	   AND cd.code = u.department_code
	WHERE u.login_id = #{loginId}
	  AND u.use_yn = TRUE
	</select>



<update id="updateUser" parameterType="com.health.app.users.UserDTO">
    UPDATE users
    SET
        name = #{name},
        email = #{email},
        phone = #{phone},
        department_code = #{departmentCode},
        branch_id = #{branchId},
        post_no = #{postNo},
        base_address = #{baseAddress},
        detail_address = #{detailAddress}
    WHERE login_id = #{loginId}
</update>

<update id="updatePassword">
    UPDATE users
    SET password = #{password}
    WHERE login_id = #{loginId}
</update>

    <select id="selectForPasswordCheck"
        parameterType="java.lang.String"
        resultType="com.health.app.users.UserDTO">
    SELECT login_id, password
    FROM users
    WHERE login_id = #{loginId}
      AND use_yn = TRUE
</select>

<update id="withdraw" parameterType="string">
    UPDATE users
    SET
        use_yn = FALSE,
        update_date = NOW()
    WHERE login_id = #{loginId}
</update>

<select id="countByLoginIdAndEmail" resultType="int">
    SELECT COUNT(*)
    FROM users
    WHERE login_id = #{loginId}
      AND email = #{email}
      AND use_yn = TRUE
</select>

    

</mapper>
